---
title: "Gap notebook"
output: Gap.nb.html
---
Load all csv files in Data

```{r, message=TRUE}
DataDir = "~/GapExperiment/Data/"
load_csv <- function(fileName){
  filePath = paste0(DataDir, fileName)
  df = read_csv(filePath)
  names(df)[ncol(df)]  = "class"
  df$class = factor(df$class)
  return(df)
}
csvFiles = list.files(path = DataDir, pattern = "*.csv")
datasetNames = lapply(csvFiles, tools::file_path_sans_ext)
datasets = lapply(csvFiles, load_csv)
datasets = setNames(datasets, datasetNames)
names(datasets)
```
Create Synthesized datasets
```{r}
sampleGaussCluster <- function (muList, sigmaList, nEach){
  nCluster = length(muList)
  stopifnot(nCluster == length(sigmaList))
  df = NULL
  for (i in seq(nCluster)){
    sampMat = MASS::mvrnorm(n = nEach[[i]], muList[[i]], sigmaList[[i]])
    sampDf = as_data_frame(sampMat)
    sampDf$class = i
    if (is.null(df)){
      df = sampDf
    } else {
      df = rbind(df, sampDf)
    }
  }
  df$class = as.factor(df$class)
  return(df)
}

#2 overlapping Gaussian
ovl2Gauss_Mu = list(c(0, 0), c(2.5, 2.5))
ovl2Gauss_Sigma = list(matrix(c(1,0.7,0.7,1),2,2), 
                      matrix(c(1, 0, 0, 1),2,2))
nEach = list(200, 200)
df = sampleGaussCluster(ovl2Gauss_Mu, ovl2Gauss_Sigma, nEach = nEach)
plot(df$V1, df$V2)
datasets[["ovl2Gauss"]] = df

#2 overlapping Gaussian
ovl2Gauss_Mu = list(c(0, 0), c(2.5, 2.5))
ovl2Gauss_Sigma = list(matrix(c(1,0.7,0.7,1),2,2), 
                      matrix(c(1, 0, 0, 1),2,2))
nEach = list(200, 200)
df = sampleGaussCluster(ovl2Gauss_Mu, ovl2Gauss_Sigma, nEach = nEach)
plot(df$V1, df$V2)
datasets[["ovl2Gauss"]] = df

#2 strong overlapping Gaussian
strOvl2Gauss_Mu = list(c(0, 0), c(2, 2))
strOvl2Gauss_Sigma = list(matrix(c(1,0.7,0.7,1),2,2), 
                      matrix(c(0.8, 0, 0, 0.8),2,2))
nEach = list(200, 200)
df = sampleGaussCluster(strOvl2Gauss_Mu, strOvl2Gauss_Sigma, nEach = nEach)
plot(df$V1, df$V2)
datasets[["strOvl2Gauss"]] = df

#3 overlapping Gaussian
ovl3Gauss_Mu = list(c(0, 0), c(2.5, 2.5), c(0, 2))
ovl3Gauss_Sigma = list(matrix(c(1,0.7,0.7,1),2,2), 
                      matrix(c(1, 0, 0, 1),2,2),
                      matrix(c(1, -0.7, -0.7, 1), 2, 2))
nEach = list(200, 200, 200)
df = sampleGaussCluster(ovl3Gauss_Mu, ovl3Gauss_Sigma, nEach = nEach)
plot(df$V1, df$V2)
datasets[["ovl3Gauss"]] = df

#4 hierchical cluster
hier4Gauss_Mu = list(c(0, 0), c(3, 4), c(4, 3), c(3, 3))
hier4Gauss_Sigma = list(matrix(c(1,0,0,1),2,2), 
                        matrix(c(0.05, 0, 0, 0.05),2,2),
                        matrix(c(0.05, 0, 0, 0.05), 2, 2),
                        matrix(c(0.05, 0, 0, 0.05), 2, 2))
nEach = list(200, 100, 100, 100)
df = sampleGaussCluster(hier4Gauss_Mu, hier4Gauss_Sigma, nEach = nEach)
plot(df$V1, df$V2)
datasets[["hier4Gauss"]] = df

```

Function to run Gap
```{r}
library(dplyr)
library(cluster)
source("clusGap.R")

runGap <- function(df, 
                   df_name, 
                   FUNcluster = kmeans, 
                   pca = TRUE, 
                   do_parallel = TRUE){
  gap = clusGap(df %>% select(-class), 
                  FUN = FUNcluster, 
                  #nstart = 20, 
                  K.max = 10,
                  #d.power = 2,
                  #spaceH0 = c("scaledPCA"),
                  pca = pca,
                  do_parallel = do_parallel,
                  B = 50,
                  verbose = TRUE)
  tibs2001SEmax = maxSE(gap$Tab[, 3], gap$Tab[, 4], method="Tibs2001SEmax")
  firstSEmax =  maxSE(gap$Tab[, 3], gap$Tab[, 4], method="firstSEmax")
  accMax = maxSE(gap$Tab[, 3], gap$Tab[, 4], method="accMax")
  plot(gap, main = paste0(df_name, ": ", nlevels(df$class), " classes;", 
                          " tibs2001SEmax: ", tibs2001SEmax,
                          " firstSEmax: ", firstSEmax,
                          " accMax: ", accMax))
  print(paste("Tibs2001SEmax:", tibs2001SEmax))
  print(paste("firstSEmax:", firstSEmax))
  print(paste("accMax:", accMax))
  print(levels(df$class))
  return(gap)
}
```
```{r}
names(datasets)
```

```{r}
#GOOD DATA:
# cancer: maxAcc fix
# glass: maxAcc + recursive?
# iris: 
# seeds: all correct
# vertebral_column: bootstrap fix!!
# wine: need maxAcc, no good
# balance_scale: always 1, SE too big
# blood: always 1, no good
# density: always good
# liver-disorders: bootstrap fix!! with maxAcc!
# mouse: missed, 4 -> predicted 3. Need recursive?
# pen: 10 classes, too big, linear increase
# skin: 2 classes, no hope
# lettr: no hope

df_name = 'ovl3Gauss'
df = datasets[[df_name]]
nums <- sapply(df, is.numeric)
#pam(df %>% select(-class), 3)
runGap(df, df_name, FUNcluster = pam, pca = TRUE, do_parallel = TRUE)

#Bootstrap
df_sample = sample_n(df, size = min(nrow(df), 500), replace = TRUE)
runGap(df_sample, df_name, FUNcluster = pam, pca = TRUE, do_parallel = TRUE)
```
